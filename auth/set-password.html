<!doctype html>
<html lang="de" data-theme="dark">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link rel="stylesheet" href="./styles.css" />
  <title>Passwort festlegen</title>

  <script type="module" src="./fluentModule.js"></script>

  <style>
    .field-label {
      font-size: .95rem;
      font-weight: 600;
      margin-bottom: .25rem;
      color: var(--fg);
    }

    fluent-text-field {
      --control-corner-radius: 12px;
      --stroke-width: 0;
      --focus-stroke-width: 0;
      font-size: 1rem;
    }

    fluent-text-field::part(root),
    fluent-text-field::part(control) {
      background: var(--input-bg);
      border: none;
      border-radius: 12px;
      box-shadow: none;
      outline: none;
      color: var(--fg);
      min-height: 44px;
    }

    fluent-text-field:focus-within::part(control) {
      border-radius: 12px;
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 70%);
    }

    form {
      display: grid;
      gap: 1rem;
    }

    .row {
      display: grid;
      gap: .35rem;
    }

    .helper {
      font-size: .95rem;
      color: var(--muted);
    }

    .checklist {
      margin: .35rem 0 0;
      padding-left: 1.2rem;
      display: grid;
      gap: .25rem;
      font-size: .9rem;
      color: var(--muted);
    }

    .checklist li {
      list-style: disc;
    }

    .checklist li.ok {
      color: var(--success);
      list-style: "✓ ";
    }

    .actions {
      display: flex;
      align-items: center;
      gap: .75rem;
      margin-top: .25rem;
      flex-wrap: wrap;
    }

    .actions fluent-button.icon-btn::part(control) {
      min-width: 72px;
      height: 30px;
      padding: 0 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 12px;
    }

    .actions fluent-button.icon-btn::part(content) {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: .4rem;
    }

    .btn-ok::part(control) {
      background: var(--success);
      border-color: var(--success);
    }

    .btn-ok .fi {
      color: #fff;
    }

    .btn-ok:hover:not([disabled])::part(control) {
      background: color-mix(in oklab, var(--success), black 8%);
      border-color: color-mix(in oklab, var(--success), black 8%);
    }

    .btn-ok[disabled]::part(control) {
      background: color-mix(in oklab, var(--success), var(--surface) 75%);
      border-color: color-mix(in oklab, var(--success), var(--surface) 75%);
      opacity: .6;
      cursor: not-allowed;
    }

    .btn-ok[disabled] .fi {
      color: color-mix(in oklab, #fff, var(--surface) 45%);
    }

    .btn-cancel::part(control) {
      background: transparent;
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn-cancel .fi {
      color: var(--danger);
    }

    .btn-cancel:hover::part(control) {
      background: color-mix(in oklab, var(--danger), transparent 90%);
    }

    #result {
      margin-top: 12px;
    }

    #result:empty {
      display: none;
      margin-top: 0;
    }

    #result .banner {
      margin: 0;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    @media (max-width: 480px) {
      fluent-text-field::part(control) {
        min-height: 48px;
        font-size: 16px;
      }

      .helper {
        font-size: .9rem;
      }

      .actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: .6rem;
      }

      .actions fluent-button.icon-btn::part(control) {
        min-width: 0;
        width: 100%;
        height: 44px;
        border-radius: 9999px;
      }
    }
  </style>
</head>

<body>
  <fluent-design-system-provider use-defaults>
    <header class="app-header">
      <div class="spacer"></div>
      <h1 class="title">Stodl Halsbach</h1>
      <div class="toolbar">
        <fluent-button id="toggleTheme" class="icon-btn btn-theme" appearance="stealth" aria-label="Theme umschalten">
          <span id="themeIcon" class="fi">&#xE708;</span>
        </fluent-button>
      </div>
    </header>

    <main>
      <fluent-card>
        <div class="card-pad">
          <div id="state-notlogged" class="banner err" style="display:none;">
            <span class="fi" aria-hidden="true">&#xE7BA;</span>
            <span>Nicht eingeloggt. Bitte den Einladungs- oder Recovery-Link öffnen.</span>
          </div>

          <div id="state-form" style="display:none;">
            <div class="banner">
              <span class="fi" aria-hidden="true">&#xE946;</span>
              <span>Neues Passwort festlegen</span>
            </div>

            <form id="pwForm" autocomplete="off" novalidate>
              <div class="row">
                <label for="pw1" class="field-label">Neues Passwort</label>
                <fluent-text-field id="pw1" type="password" appearance="outline" placeholder="••••••••" minlength="8"
                  required autocomplete="new-password"></fluent-text-field>
                <ul class="checklist" id="policyList" aria-live="polite">
                  <li id="chkLen">Mindestens 8 Zeichen</li>
                  <li id="chkLower">Mindestens 1 Kleinbuchstabe (a–z)</li>
                  <li id="chkUpper">Mindestens 1 Großbuchstabe (A–Z)</li>
                  <li id="chkDigit">Mindestens 1 Zahl (0–9)</li>
                  <li id="chkSpecial">Mindestens 1 Sonderzeichen (!@#$…)</li>
                </ul>
              </div>

              <div class="row">
                <label for="pw2" class="field-label">Passwort wiederholen</label>
                <fluent-text-field id="pw2" type="password" appearance="outline" placeholder="••••••••" minlength="8"
                  required autocomplete="new-password"></fluent-text-field>
                <div class="helper" id="matchHelper" style="display:none;">Passwörter stimmen nicht überein.</div>
              </div>

              <div class="actions">
                <fluent-button id="btnSave" appearance="accent" type="submit" class="icon-btn btn-ok"
                  aria-label="Speichern" disabled>
                  <span class="fi" aria-hidden="true">&#xE73E;</span>
                </fluent-button>
                <fluent-button appearance="outline" href="/" class="icon-btn btn-cancel" aria-label="Abbrechen">
                  <span class="fi" aria-hidden="true">&#xE711;</span>
                </fluent-button>
              </div>
            </form>

            <div id="result" role="status" aria-live="polite"></div>
          </div>
        </div>
      </fluent-card>
    </main>
  </fluent-design-system-provider>

  <script src="/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const saved = localStorage.getItem('theme');
    const setTheme = (mode) => {
      document.documentElement.dataset.theme = mode;
      localStorage.setItem('theme', mode);
      document.getElementById('themeIcon').innerHTML =
        mode === 'dark' ? '&#xE708;' : '&#xE706;';
      import("https://cdn.jsdelivr.net/npm/@fluentui/web-components@2.6.1/dist/web-components.min.js")
        .then(m => {
          const provider = document.querySelector('fluent-design-system-provider');
          m.baseLayerLuminance.setValueFor(
            provider,
            mode === 'dark' ? m.StandardLuminance.DarkMode : m.StandardLuminance.LightMode
          );
        });
    };
    if (saved === 'light' || saved === 'dark') setTheme(saved);
    document.getElementById('toggleTheme')?.addEventListener('click', () => {
      const next = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
      setTheme(next);
    });

    const { url, anonKey } = window.SUPABASE_CONFIG || {};
    const supabase = window.supabase.createClient(url, anonKey);

    const notlogged = document.getElementById('state-notlogged');
    const formWrap = document.getElementById('state-form');
    const form = document.getElementById('pwForm');
    const result = document.getElementById('result');
    const pw1El = document.getElementById('pw1');
    const pw2El = document.getElementById('pw2');
    const matchHelper = document.getElementById('matchHelper');
    const btnSave = document.getElementById('btnSave');

    const chk = {
      len: document.getElementById('chkLen'),
      lower: document.getElementById('chkLower'),
      upper: document.getElementById('chkUpper'),
      digit: document.getElementById('chkDigit'),
      special: document.getElementById('chkSpecial')
    };
    const policy = {
      len: /.{8,}/,
      lower: /[a-z]/,
      upper: /[A-Z]/,
      digit: /[0-9]/,
      special: /[!@#$%^&*()_\+\-\=\[\]{};':"\\|<>?,.\/`~]/
    };
    function updateChecklist(v) {
      chk.len.classList.toggle('ok', policy.len.test(v));
      chk.lower.classList.toggle('ok', policy.lower.test(v));
      chk.upper.classList.toggle('ok', policy.upper.test(v));
      chk.digit.classList.toggle('ok', policy.digit.test(v));
      chk.special.classList.toggle('ok', policy.special.test(v));
    }
    function allRequirementsMet(v) {
      return policy.len.test(v) && policy.lower.test(v) && policy.upper.test(v) && policy.digit.test(v) && policy.special.test(v);
    }
    function updateSubmitState() {
      const v1 = pw1El.value || '';
      const v2 = pw2El.value || '';
      const match = v1 === v2 && v2.length > 0;
      const okReq = allRequirementsMet(v1);
      matchHelper.style.display = match || v2.length === 0 ? 'none' : '';
      const enable = okReq && match;
      btnSave.toggleAttribute('disabled', !enable);
      btnSave.setAttribute('aria-disabled', String(!enable));
    }

    pw1El.addEventListener('input', (e) => { updateChecklist(e.target.value || ''); updateSubmitState(); });
    pw2El.addEventListener('input', updateSubmitState);

    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) { notlogged.style.display = ''; formWrap.style.display = 'none'; return; }
      notlogged.style.display = 'none';
      formWrap.style.display = '';
      updateChecklist('');
      updateSubmitState();
    })();

    const bannerErr = (text) =>
      `<div class="banner err"><span class="fi" aria-hidden="true">&#xE7BA;</span><span>${text}</span></div>`;
    const bannerOk = (text) =>
      `<div class="banner"><span class="fi" aria-hidden="true">&#xE73E;</span><span>${text}</span></div>`;

    function validatePassword(pw) {
      const fails = [];
      if (!policy.len.test(pw)) fails.push('mindestens 8 Zeichen');
      if (!policy.lower.test(pw)) fails.push('mind. 1 Kleinbuchstabe (a–z)');
      if (!policy.upper.test(pw)) fails.push('mind. 1 Großbuchstabe (A–Z)');
      if (!policy.digit.test(pw)) fails.push('mind. 1 Zahl (0–9)');
      if (!policy.special.test(pw)) fails.push('mind. 1 Sonderzeichen (!@#$…)');
      return fails;
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (btnSave.hasAttribute('disabled')) return;

      result.textContent = '';
      const pw1 = (pw1El.value || '').trim();
      const pw2 = (pw2El.value || '').trim();

      if (pw1 !== pw2) {
        matchHelper.style.display = '';
        result.innerHTML = bannerErr('Passwörter stimmen nicht überein.');
        return;
      }
      const issues = validatePassword(pw1);
      if (issues.length) {
        result.innerHTML = bannerErr('Das Passwort erfüllt nicht die Anforderungen: ' + issues.join(', ') + '.');
        return;
      }

      const { error } = await supabase.auth.updateUser({ password: pw1 });
      if (error) {
        const raw = error.message || '';
        if (/Password should contain at least one character/i.test(raw)) {
          result.innerHTML = bannerErr('Das Passwort muss mindestens je 1 Kleinbuchstaben, 1 Großbuchstaben, 1 Zahl und 1 Sonderzeichen enthalten.');
        } else {
          result.innerHTML = bannerErr(`Fehler: ${raw}`);
        }
        return;
      }

      result.innerHTML = bannerOk('Gespeichert.');
      setTimeout(() => location.href = '/', 1200);
    });
  </script>
</body>

</html>