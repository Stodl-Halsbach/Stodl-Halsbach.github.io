<!doctype html>
<html lang="de" data-theme="dark">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link rel="stylesheet" href="./styles.css" />
  <title>Anmeldung bestätigen</title>

  <script type="module" src="./fluentModule.js"></script>

  <style>
    .muted {
      color: var(--muted);
      margin: .25rem 0 0;
    }

    .center {
      display: grid;
      place-items: center;
      gap: .75rem;
      min-height: 30vh;
    }

    @media (max-width: 480px) {
      .center {
        min-height: 25vh;
        gap: .6rem;
      }
    }
  </style>
</head>

<body>
  <fluent-design-system-provider use-defaults>
    <header class="app-header">
      <div class="spacer"></div>
      <h1 class="title">Stodl Halsbach</h1>
      <div class="toolbar">
        <fluent-button id="toggleTheme" class="btn-theme" appearance="stealth" aria-label="Theme umschalten">
          <span id="themeIcon" class="fi">&#xE708;</span>
        </fluent-button>
      </div>
    </header>

    <main>
      <fluent-card>
        <div class="card-pad">
          <div id="loading" class="center">
            <fluent-progress-ring></fluent-progress-ring>
            <div class="muted">Anmeldung wird abgeschlossen…</div>
          </div>

          <div id="error" style="display:none;">
            <div class="banner err">
              <span class="fi" aria-hidden="true">&#xE7BA;</span>
              <span>Nicht eingeloggt. Bitte den Einladungs- oder Recovery-Link öffnen.</span>
            </div>
          </div>
        </div>
      </fluent-card>
    </main>
  </fluent-design-system-provider>

  <script src="/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const saved = localStorage.getItem('theme');
    const setTheme = (mode) => {
      document.documentElement.dataset.theme = mode;
      localStorage.setItem('theme', mode);
      document.getElementById('themeIcon').innerHTML = mode === 'dark' ? '&#xE708;' : '&#xE706;';
      import("https://cdn.jsdelivr.net/npm/@fluentui/web-components@2.6.1/dist/web-components.min.js")
        .then(m => {
          const provider = document.querySelector('fluent-design-system-provider');
          m.baseLayerLuminance.setValueFor(
            provider,
            mode === 'dark' ? m.StandardLuminance.DarkMode : m.StandardLuminance.LightMode
          );
        });
    };
    if (saved === 'light' || saved === 'dark') setTheme(saved);
    document.getElementById('toggleTheme')?.addEventListener('click', () => {
      const next = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
      setTheme(next);
    });

    const { url, anonKey } = window.SUPABASE_CONFIG || {};
    const supabase = window.supabase.createClient(url, anonKey);

    const $ = id => document.getElementById(id);
    const show = id => ($(id).style.display = '');
    const hide = id => ($(id).style.display = 'none');

    (async () => {
      try {
        if (location.search.includes('code=')) {
          const { error } = await supabase.auth.exchangeCodeForSession(location.href);
          if (error) throw error;
        } else if (location.hash.includes('access_token')) {
          const params = new URLSearchParams(location.hash.slice(1));
          const { error } = await supabase.auth.setSession({
            access_token: params.get('access_token'),
            refresh_token: params.get('refresh_token')
          });
          if (error) throw error;
        } else {
          throw new Error('Kein Token in der URL gefunden.');
        }

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Session konnte nicht hergestellt werden.');

        location.replace('/auth/set-password.html');
      } catch (e) {
        hide('loading'); show('error');
        $('errMsg').textContent = (e && e.message) ? e.message : String(e);
      }
    })();
  </script>
</body>

</html>