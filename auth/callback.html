<!doctype html>
<html lang="de" data-theme="dark">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anmeldung bestÃ¤tigen</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@fluentui/web-components@latest"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, "Segoe UI Variable", sans-serif;
      background: #181818;
      color: #f3f3f3;
    }

    [data-theme="light"] {
      background: #fff;
      color: #222;
    }

    header {
      border-bottom: 1px solid color-mix(in oklab, CanvasText, Canvas 85%);
      padding: .5rem 1rem;
      display: flex;
      justify-content: space-between;
    }

    main {
      max-width: 680px;
      margin: 3rem auto;
      padding: 0 1rem;
    }

    fluent-design-system-provider {
      --accent-fill-rest: #1D4ED8;
    }

    .center {
      display: grid;
      place-items: center;
      gap: .5rem;
      min-height: 30vh;
    }

    .actions {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
  </style>
</head>

<body>
  <fluent-design-system-provider use-defaults>
    <header>
      <div class="brand">ðŸ”‘ Anmeldung</div>
      <fluent-button id="toggleTheme">Light/Dark</fluent-button>
    </header>
    <main>
      <h1>Anmeldung wird abgeschlossenâ€¦</h1>
      <fluent-card>
        <div style="padding:1rem 1.25rem;">
          <div id="loading" class="center">
            <fluent-progress-ring></fluent-progress-ring>
            <p>Bitte einen Momentâ€¦</p>
          </div>
          <div id="success" style="display:none;">
            <fluent-alert appearance="accent">Anmeldung erfolgreich ðŸŽ‰</fluent-alert>
            <p id="userLine" style="margin-top:.5rem;"></p>
            <div class="actions">
              <fluent-button appearance="accent" href="/">Zur Startseite</fluent-button>
              <fluent-button appearance="outline" href="/auth/set-password.html">Passwort setzen</fluent-button>
            </div>
          </div>
          <div id="error" style="display:none;">
            <fluent-alert appearance="error">Ups â€“ Anmeldung fehlgeschlagen</fluent-alert>
            <pre id="errMsg" style="white-space:pre-wrap;margin-top:.5rem;"></pre>
            <fluent-button href="/" appearance="outline">Zur Startseite</fluent-button>
          </div>
        </div>
      </fluent-card>
    </main>
  </fluent-design-system-provider>

  <script src="/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { url, anonKey } = window.SUPABASE_CONFIG || {};
    const supabase = window.supabase.createClient(url, anonKey);
    const $ = id => document.getElementById(id);
    const show = id => ($(id).style.display = ''); const hide = id => ($(id).style.display = 'none');

    (async () => {
      try {
        if (location.search.includes('code=')) {
          const { error } = await supabase.auth.exchangeCodeForSession(location.href);
          if (error) throw error;
        } else if (location.hash.includes('access_token')) {
          const f = new URLSearchParams(location.hash.slice(1));
          const { error } = await supabase.auth.setSession({ access_token: f.get('access_token'), refresh_token: f.get('refresh_token') });
          if (error) throw error;
        } else throw new Error("Kein Token in URL gefunden.");
        const { data: { user } } = await supabase.auth.getUser();
        hide('loading'); show('success');
        $('userLine').textContent = `Eingeloggt als ${user?.email || ''}`;
      } catch (e) {
        hide('loading'); show('error');
        $('errMsg').textContent = e.message || String(e);
      }
    })();

    document.getElementById('toggleTheme').onclick = () => {
      document.documentElement.dataset.theme =
        document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
    };
  </script>
</body>

</html>